#!/bin/bash
# Start TrinityCore servers

# Check for background flag
BACKGROUND=false
if [ "$1" == "--background" ]; then
    BACKGROUND=true
fi

cd /home/peacebloom/server/bin

echo "=== Starting TrinityCore Servers ==="

# Create logs directory if it doesn't exist
mkdir -p /home/peacebloom/server/logs

# Ensure MySQL is running
if ! pgrep mysqld > /dev/null; then
    echo "Starting MySQL..."
    sudo service mysql start
    sleep 3
fi

# Start authserver
if pgrep -x authserver > /dev/null 2>&1; then
    echo "Authserver already running"
else
    echo "Starting authserver..."
    setsid ./authserver > /home/peacebloom/server/logs/authserver.log 2>&1 &
    sleep 2
    if pgrep -x authserver > /dev/null 2>&1; then
        echo "Authserver started (PID: $(pgrep -x authserver))"
    else
        echo "Warning: Authserver may have failed to start. Check /home/peacebloom/server/logs/authserver.log"
    fi
fi

# Start worldserver
# Create logs directory if it doesn't exist
mkdir -p /home/peacebloom/server/logs

if pgrep -x worldserver > /dev/null 2>&1; then
    echo "Worldserver already running"
    echo "Logs: tail -f /home/peacebloom/server/logs/worldserver.log"
    echo "To access console: docker exec -it peacebloom bash"
    echo "Then: cd /home/peacebloom/server/bin && ./worldserver"
else
    if [ "$BACKGROUND" = true ]; then
        echo "Starting worldserver in background..."
        setsid ./worldserver > /home/peacebloom/server/logs/worldserver.log 2>&1 &
        sleep 5
        if pgrep -x worldserver > /dev/null 2>&1; then
            echo "Worldserver started (PID: $(pgrep -x worldserver))"
            echo "Logs: tail -f /home/peacebloom/server/logs/worldserver.log"
        else
            echo "Warning: Worldserver may have failed to start. Check /home/peacebloom/server/logs/worldserver.log"
        fi
    else
        echo "Starting worldserver in foreground..."
        echo ""
        echo "=== Worldserver Console ==="
        echo "Create accounts with:"
        echo "  account create <username> <password>"
        echo "  account set gmlevel <username> 3 -1"
        echo ""
        echo "To run in background with file logging, use: start --background"
        echo ""
        # Run worldserver directly without tee - output goes to console only
        ./worldserver
    fi
fi
