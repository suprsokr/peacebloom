#!/bin/bash
# Build TrinityCore from source
# Run this inside the container after mounting tc-source

set -e

echo "=== Building TrinityCore 3.3.5 ==="

cd /home/peacebloom/TrinityCore

# Check if source exists
if [ ! -f "CMakeLists.txt" ]; then
    echo "Error: TrinityCore source not found at /home/peacebloom/TrinityCore/"
    echo "Make sure tc-source is mounted and contains the TrinityCore source"
    exit 1
fi

# Create build directory
if [ ! -d "build" ]; then
    mkdir build
fi

cd build

# Only run CMake if not configured yet, or if --configure flag passed
NEEDS_CMAKE=false
if [ ! -f "Makefile" ]; then
    NEEDS_CMAKE=true
fi
if [ "$1" = "--configure" ] || [ "$1" = "-c" ]; then
    NEEDS_CMAKE=true
fi

if [ "$NEEDS_CMAKE" = true ]; then
    echo "Configuring CMake..."
    # Enables spells, commands and custom scripts.
    cmake ../ \
        -DCMAKE_BUILD_TYPE=Debug \
        -DWITH_WARNINGS=0 \
        -DUSE_SCRIPTPCH=1 \
        -DUSE_COREPCH=1 \
        -DTOOLS=0 \
        -DWITH_WARNINGS=1 \
        -DSERVERS=1 \
        -DSCRIPTS=minimal-static \
        -DSCRIPTS_CUSTOM=static \
        -DCMAKE_INSTALL_PREFIX=/home/peacebloom/server
else
    echo "Skipping CMake (already configured). Use --configure to reconfigure."
fi

# Build
echo "Building TrinityCore..."
make -j$(nproc)

# Install
echo "Installing TrinityCore..."
make install

# Copy config files if they don't exist
if [ ! -f /home/peacebloom/server/etc/worldserver.conf ]; then
    cp /home/peacebloom/server/etc/worldserver.conf.dist /home/peacebloom/server/etc/worldserver.conf
fi

if [ ! -f /home/peacebloom/server/etc/authserver.conf ]; then
    cp /home/peacebloom/server/etc/authserver.conf.dist /home/peacebloom/server/etc/authserver.conf
fi

echo ""
echo "=== Build Complete ==="
echo "Binaries installed to: /home/peacebloom/server/bin/"
echo "Configs at: /home/peacebloom/server/etc/"
